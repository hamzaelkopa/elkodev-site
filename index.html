import React, { useState, useEffect, useRef } from 'react';
import * as THREE from 'three';
// تصحيح استيراد الرموز لضمان عملها بشكل صحيح
import { 
  Send, 
  User, 
  PlusCircle, 
  Image as ImageIcon, 
  Moon, 
  Sun, 
  Trash2, 
  ChevronRight,
  Settings,
  X,
  ShieldCheck,
  Cpu,
  RotateCcw,
  RefreshCw
} from 'lucide-react';

const apiKey = ""; 

// --- خلفية ثلاثية الأبعاد احترافية ---
const LuxuryBackground = ({ isDarkMode }) => {
  const mountRef = useRef(null);

  useEffect(() => {
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    mountRef.current.appendChild(renderer.domElement);

    const group = new THREE.Group();
    
    // قلب النظام (Core)
    const coreGeom = new THREE.IcosahedronGeometry(4, 2);
    const coreMat = new THREE.MeshPhongMaterial({ 
      color: 0x00d2ff, 
      wireframe: true,
      transparent: true,
      opacity: 0.1
    });
    const core = new THREE.Mesh(coreGeom, coreMat);
    group.add(core);

    // جزيئات محيطة (Particles)
    const pointsGeom = new THREE.BufferGeometry();
    const count = 500;
    const positions = new Float32Array(count * 3);
    for(let i = 0; i < count * 3; i++) {
      positions[i] = (Math.random() - 0.5) * 30;
    }
    pointsGeom.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    const pointsMat = new THREE.PointsMaterial({
      size: 0.05,
      color: 0x9d50bb,
      transparent: true,
      opacity: 0.5
    });
    const points = new THREE.Points(pointsGeom, pointsMat);
    group.add(points);

    scene.add(group);
    
    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(1, 1, 1);
    scene.add(light);
    scene.add(new THREE.AmbientLight(0xffffff, 0.5));

    camera.position.z = 15;

    const animate = () => {
      requestAnimationFrame(animate);
      group.rotation.y += 0.001;
      group.rotation.x += 0.0005;
      renderer.render(scene, camera);
    };
    animate();

    const handleResize = () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    };
    window.addEventListener('resize', handleResize);
    return () => {
      window.removeEventListener('resize', handleResize);
      mountRef.current?.removeChild(renderer.domElement);
    };
  }, []);

  return <div ref={mountRef} className={`fixed inset-0 -z-10 transition-colors duration-1000 ${isDarkMode ? 'bg-[#020617]' : 'bg-[#f8fafc]'}`} />;
};

const App = () => {
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [isDarkMode, setIsDarkMode] = useState(false);
  const [attachedImage, setAttachedImage] = useState(null);
  const [showSettings, setShowSettings] = useState(false);
  const messagesEndRef = useRef(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages, isLoading]);

  const handleSend = async (e) => {
    e.preventDefault();
    if (!input.trim() && !attachedImage) return;

    const userMsg = { 
      role: 'user', 
      content: input, 
      image: attachedImage, 
      time: new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) 
    };
    
    setMessages(prev => [...prev, userMsg]);
    setInput('');
    setAttachedImage(null);
    setIsLoading(true);

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [{ text: input }, ...(userMsg.image ? [{ inlineData: { mimeType: "image/png", data: userMsg.image.split(',')[1] } }] : [])]
          }],
          tools: [{ "google_search": {} }],
          systemInstruction: { parts: [{ text: "أنت elkopa، مساعد ذكاء اصطناعي فائق صممه حمزة القبة. رد بالعربية." }] }
        })
      });

      const data = await response.json();
      const botMsg = { 
        role: 'bot', 
        content: data.candidates?.[0]?.content?.parts?.[0]?.text || "حدث خطأ في النظام.", 
        time: new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }),
        sources: data.candidates?.[0]?.groundingMetadata?.groundingAttributions?.map(a => ({ uri: a.web?.uri, title: a.web?.title }))
      };

      setMessages(prev => [...prev, botMsg]);
    } catch (err) {
      setMessages(prev => [...prev, { role: 'bot', content: "فشل الاتصال بالخادم.", time: "" }]);
    } finally {
      setIsLoading(false);
    }
  };

  const clearChat = () => {
    setMessages([]);
    setAttachedImage(null);
    setShowSettings(false);
  };

  // Neumorphic Styles (تصميم عصري)
  const neumorphicIn = isDarkMode 
    ? `shadow-[inset_2px_2px_5px_#000,inset_-2px_-2px_5px_#1e293b] border-white/5` 
    : `shadow-[inset_2px_2px_5px_#d1d9e6,inset_-2px_-2px_5px_#ffffff] border-slate-200/50`;
  
  const neumorphicOut = isDarkMode 
    ? `shadow-[3px_3px_6px_#000,-2px_-2px_6px_#1e293b] border-white/10` 
    : `shadow-[3px_3px_6px_#d1d9e6,-3px_-3px_6px_#ffffff] border-slate-200/60`;

  const textStyle = isDarkMode ? "text-slate-200" : "text-black";

  return (
    <div className={`flex h-screen w-full font-sans transition-all duration-700 overflow-hidden text-[13px] ${textStyle}`} dir="rtl">
      <LuxuryBackground isDarkMode={isDarkMode} />

      {/* Sidebar */}
      <aside className={`w-14 md:w-52 flex flex-col z-30 transition-all p-2 ${isDarkMode ? 'bg-[#020617]/80' : 'bg-white/80'} backdrop-blur-md border-l ${isDarkMode ? 'border-white/5' : 'border-slate-200'}`}>
        <div className={`p-3 rounded-xl mb-4 flex flex-col items-center gap-1 transition-all ${neumorphicOut}`}>
          <div className="w-8 h-8 bg-gradient-to-br from-[#00d2ff] to-[#9d50bb] rounded-lg flex items-center justify-center shadow-lg">
             <Cpu className="text-white w-5 h-5" />
          </div>
          <h1 className="text-[12px] font-black italic tracking-tighter hidden md:block text-[#00d2ff]">ELKOPA</h1>
        </div>

        <div className="flex-1 space-y-2 overflow-y-auto scrollbar-hide">
          <button onClick={clearChat} className={`w-full flex items-center justify-center md:justify-start gap-2 p-2.5 rounded-lg transition-all active:scale-95 ${neumorphicOut} hover:scale-[1.02]`}>
            <PlusCircle size={16} className="text-[#00d2ff]" />
            <span className="hidden md:block font-bold text-[10px]">جديد</span>
          </button>

          <button onClick={clearChat} className={`w-full flex items-center justify-center md:justify-start gap-2 p-2.5 rounded-lg transition-all active:scale-95 ${neumorphicOut} hover:text-red-500`}>
            <Trash2 size={16} className="text-slate-400" />
            <span className="hidden md:block font-bold text-[10px]">مسح</span>
          </button>
        </div>

        <div className="mt-auto space-y-2">
           <div className={`p-2 rounded-lg hidden md:block text-center ${neumorphicIn}`}>
              <div className="text-[8px] font-bold text-[#6e48aa] uppercase">المطور</div>
              <div className="text-[10px] font-black italic">حمزة القبة</div>
           </div>
           
           <button onClick={() => setIsDarkMode(!isDarkMode)} className={`flex items-center justify-center md:justify-between w-full p-2.5 rounded-lg transition-all ${neumorphicOut} active:scale-95`}>
              <span className="hidden md:block text-[9px] font-bold uppercase">{isDarkMode ? 'نهاري' : 'ليلي'}</span>
              {isDarkMode ? <Sun size={14} className="text-[#00d2ff]" /> : <Moon size={14} className="text-[#9d50bb]" />}
           </button>
        </div>
      </aside>

      {/* Main Content */}
      <main className="flex-1 flex flex-col relative">
        <header className={`h-12 flex items-center justify-between px-6 m-2 rounded-xl transition-all ${neumorphicOut} backdrop-blur-sm`}>
          <div className="flex items-center gap-2">
            <div className="w-2 h-2 rounded-full bg-[#00d2ff] shadow-[0_0_8px_#00d2ff]" />
            <span className="text-[9px] font-bold tracking-[0.2em] opacity-60">ELKOPA V2.5</span>
          </div>
          <button onClick={() => setShowSettings(!showSettings)} className={`p-1.5 rounded-lg transition-all ${neumorphicOut} hover:text-[#9d50bb]`}>
            <Settings size={14} />
          </button>
        </header>

        {/* Settings Modal */}
        {showSettings && (
          <div className="absolute inset-0 z-50 flex items-center justify-center p-4 bg-black/20 backdrop-blur-sm">
            <div className={`w-64 p-5 rounded-2xl ${neumorphicOut} ${isDarkMode ? 'bg-[#0f172a]' : 'bg-white'}`}>
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-xs font-black text-[#00d2ff]">الإعدادات</h3>
                <button onClick={() => setShowSettings(false)}><X size={14} /></button>
              </div>
              <div className="space-y-3">
                <button onClick={() => setIsDarkMode(!isDarkMode)} className={`w-full p-2.5 rounded-lg text-[10px] flex justify-between items-center ${neumorphicIn}`}>
                   <span>تبديل الوضع</span>
                   {isDarkMode ? <Sun size={12} /> : <Moon size={12} />}
                </button>
                <button onClick={clearChat} className={`w-full p-2.5 rounded-lg text-[10px] flex justify-between items-center text-red-500 ${neumorphicIn}`}>
                   <span>تصفير المحادثة</span>
                   <RotateCcw size={12} />
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Chat Area */}
        <div className="flex-1 overflow-y-auto px-4 md:px-20 py-4 space-y-6 scrollbar-hide">
          {messages.length === 0 ? (
            <div className="h-full flex flex-col items-center justify-center opacity-50">
              <Cpu size={40} className="text-[#00d2ff] mb-2 animate-pulse" />
              <h2 className="text-xl font-black italic tracking-tighter">ELKOPA 3D</h2>
              <p className="text-[9px] uppercase tracking-widest font-bold">Hamza Elkopa Edition</p>
            </div>
          ) : (
            messages.map((msg, idx) => (
              <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                <div className={`flex gap-3 max-w-[85%] ${msg.role === 'user' ? 'flex-row-reverse' : 'flex-row'}`}>
                  <div className={`w-8 h-8 rounded-lg flex-shrink-0 flex items-center justify-center ${neumorphicOut}`}>
                    {msg.role === 'user' ? <User size={14} className="text-[#9d50bb]" /> : <Cpu size={14} className="text-[#00d2ff]" />}
                  </div>
                  <div className={`p-4 rounded-2xl ${msg.role === 'user' ? 'bg-[#1e293b] text-white' : `${neumorphicOut} bg-white/40`}`}>
                    {msg.image && <img src={msg.image} className="rounded-lg mb-2 max-w-[180px]" alt="user-upload" />}
                    <div className="leading-relaxed font-semibold">{msg.content}</div>
                    <div className="text-[8px] mt-2 opacity-30 text-left">{msg.time}</div>
                  </div>
                </div>
              </div>
            ))
          )}
          {isLoading && (
            <div className="flex items-center gap-2 px-6">
              <RefreshCw size={12} className="animate-spin text-[#00d2ff]" />
              <span className="text-[9px] font-bold opacity-40">جاري المعالجة...</span>
            </div>
          )}
          <div ref={messagesEndRef} />
        </div>

        {/* Input Area */}
        <div className="p-3 md:p-6">
          <form onSubmit={handleSend} className="max-w-3xl mx-auto relative">
            <div className={`flex items-center gap-2 p-1.5 rounded-2xl transition-all ${neumorphicOut} backdrop-blur-md`}>
              <textarea
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && !e.shiftKey && handleSend(e)}
                placeholder="اسأل نظام elkopa..."
                className="flex-1 bg-transparent px-4 py-3 outline-none resize-none text-[13px] min-h-[40px] max-h-32 placeholder:text-slate-400 font-medium"
                rows={1}
              />
              <div className="flex items-center gap-1.5 pr-2">
                <label className={`p-2 rounded-full cursor-pointer transition-all ${neumorphicOut} hover:text-[#00d2ff]`}>
                  <ImageIcon size={14} />
                  <input type="file" className="hidden" accept="image/*" onChange={(e) => {
                    const reader = new FileReader();
                    if(e.target.files[0]) {
                      reader.onload = () => setAttachedImage(reader.result);
                      reader.readAsDataURL(e.target.files[0]);
                    }
                  }} />
                </label>
                <button type="submit" disabled={isLoading} className={`p-2.5 rounded-full bg-gradient-to-r from-[#00d2ff] to-[#9d50bb] text-white shadow-lg active:scale-90 transition-all ${isLoading ? 'opacity-50' : ''}`}>
                  <Send size={14} />
                </button>
              </div>
            </div>
            <div className="text-center mt-2">
               <span className="text-[7px] font-black uppercase tracking-[0.3em] opacity-40 flex items-center justify-center gap-1">
                 <ShieldCheck size={8} /> محمية بنظام حمزة القبة التقني
               </span>
            </div>
          </form>
        </div>
      </main>
    </div>
  );
};

export default App;
