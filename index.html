import React, { useState, useEffect, useRef } from 'react';
import * as THREE from 'three';
import { 
  Send, 
  Bot, 
  User, 
  PlusCircle, 
  Image as ImageIcon, 
  Moon, 
  Sun, 
  Trash2, 
  Search,
  ChevronRight,
  Sparkles,
  MessageSquare,
  Settings,
  Layers,
  X,
  ShieldCheck,
  Cpu,
  RotateCcw
} from 'lucide-react';

const apiKey = ""; 

// --- 3D Scene Background ---
const LuxuryBackground = ({ isDarkMode }) => {
  const mountRef = useRef(null);

  useEffect(() => {
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    mountRef.current.appendChild(renderer.domElement);

    const brainGroup = new THREE.Group();
    
    const coreGeom = new THREE.IcosahedronGeometry(4, 1);
    const coreMat = new THREE.MeshPhongMaterial({ 
      color: 0x00d2ff, 
      wireframe: true,
      transparent: true,
      opacity: 0.15
    });
    const core = new THREE.Mesh(coreGeom, coreMat);
    brainGroup.add(core);

    const outerGeom = new THREE.SphereGeometry(10, 32, 32);
    const outerMat = new THREE.PointsMaterial({
      size: 0.08,
      color: 0x9d50bb,
      transparent: true,
      opacity: 0.3
    });
    const outer = new THREE.Points(outerGeom, outerMat);
    brainGroup.add(outer);

    scene.add(brainGroup);
    const light = new THREE.PointLight(0xffffff, 1);
    light.position.set(10, 20, 30);
    scene.add(light);
    scene.add(new THREE.AmbientLight(0x404040, 1.5));

    camera.position.z = 20;

    const animate = () => {
      requestAnimationFrame(animate);
      brainGroup.rotation.y += 0.001;
      renderer.render(scene, camera);
    };
    animate();

    const handleResize = () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    };
    window.addEventListener('resize', handleResize);
    return () => {
      window.removeEventListener('resize', handleResize);
      mountRef.current?.removeChild(renderer.domElement);
    };
  }, [isDarkMode]);

  return <div ref={mountRef} className={`fixed inset-0 -z-10 transition-colors duration-1000 ${isDarkMode ? 'bg-slate-950' : 'bg-[#f8fafc]'}`} />;
};

const App = () => {
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [isDarkMode, setIsDarkMode] = useState(false);
  const [attachedImage, setAttachedImage] = useState(null);
  const [showSettings, setShowSettings] = useState(false);
  const messagesEndRef = useRef(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages, isLoading]);

  const handleSend = async (e) => {
    e.preventDefault();
    if (!input.trim() && !attachedImage) return;

    const userMsg = { 
      role: 'user', 
      content: input, 
      image: attachedImage, 
      time: new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) 
    };
    
    setMessages(prev => [...prev, userMsg]);
    setInput('');
    setAttachedImage(null);
    setIsLoading(true);

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [{ text: input }, ...(userMsg.image ? [{ inlineData: { mimeType: "image/png", data: userMsg.image.split(',')[1] } }] : [])]
          }],
          tools: [{ "google_search": {} }],
          systemInstruction: { parts: [{ text: "أنت elkopa، مساعد ذكاء اصطناعي فائق صممه المطور حمزة القبة. لغتك عربية فصيحة." }] }
        })
      });

      const data = await response.json();
      const botMsg = { 
        role: 'bot', 
        content: data.candidates?.[0]?.content?.parts?.[0]?.text || "عذراً، حدث خطأ.", 
        time: new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }),
        sources: data.candidates?.[0]?.groundingMetadata?.groundingAttributions?.map(a => ({ uri: a.web?.uri, title: a.web?.title }))
      };

      setMessages(prev => [...prev, botMsg]);
    } catch (err) {
      setMessages(prev => [...prev, { role: 'bot', content: "خطأ في الشبكة.", time: "" }]);
    } finally {
      setIsLoading(false);
    }
  };

  const clearChat = () => {
    setMessages([]);
    setAttachedImage(null);
    setShowSettings(false);
  };

  // Minimized Neumorphic Styles
  const neumorphicIn = isDarkMode 
    ? `shadow-[inset_2px_2px_5px_#020617,inset_-2px_-2px_5px_#1e293b] border-white/5` 
    : `shadow-[inset_2px_2px_5px_#d1d9e6,inset_-2px_-2px_5px_#ffffff] border-slate-200/50`;
  
  const neumorphicOut = isDarkMode 
    ? `shadow-[3px_3px_7px_#020617,-3px_-3px_7px_#1e293b] border-white/10` 
    : `shadow-[3px_3px_7px_#d1d9e6,-3px_-3px_7px_#ffffff] border-slate-200/60`;

  const textStyle = isDarkMode ? "text-slate-200" : "text-black";

  return (
    <div className={`flex h-screen w-full font-sans transition-all duration-700 overflow-hidden text-[13px] ${textStyle}`} dir="rtl">
      <LuxuryBackground isDarkMode={isDarkMode} />

      {/* Sidebar - Minimized */}
      <aside className={`w-14 md:w-52 flex flex-col z-30 transition-all p-2 ${isDarkMode ? 'bg-slate-950/70' : 'bg-white/70'}`}>
        <div className={`p-3 rounded-xl mb-4 flex flex-col items-center gap-1 transition-all ${neumorphicOut} border-t border-t-[#00d2ff]`}>
          <div className="w-8 h-8 bg-gradient-to-br from-[#00d2ff] via-[#9d50bb] to-[#6e48aa] rounded-lg flex items-center justify-center shadow-md">
             <Cpu className="text-white w-5 h-5" />
          </div>
          <h1 className="text-[14px] font-black italic tracking-widest hidden md:block text-transparent bg-clip-text bg-gradient-to-r from-[#00d2ff] to-[#9d50bb]">ELKOPA</h1>
        </div>

        <div className="flex-1 space-y-3 overflow-y-auto scrollbar-hide">
          <button 
            onClick={clearChat}
            className={`w-full flex items-center justify-center md:justify-start gap-2 p-3 rounded-lg transition-all active:scale-95 ${neumorphicOut} hover:scale-[1.02] group`}
          >
            <PlusCircle size={16} className="text-[#00d2ff]" />
            <span className="hidden md:block font-bold text-[10px] uppercase">جديد</span>
          </button>

          <button 
            onClick={clearChat}
            className={`w-full flex items-center justify-center md:justify-start gap-2 p-3 rounded-lg transition-all active:scale-95 ${neumorphicOut} hover:text-red-500 group`}
          >
            <Trash2 size={16} className="text-slate-400 group-hover:text-red-500" />
            <span className="hidden md:block font-bold text-[10px] uppercase">مسح</span>
          </button>

          <div className={`p-2 rounded-lg hidden md:block text-center transition-all ${neumorphicIn} border-b border-b-[#9d50bb]/20`}>
            <div className="text-[8px] font-bold text-[#6e48aa] uppercase">المطور</div>
            <div className="text-[10px] font-black">حمزة القبة</div>
          </div>
        </div>

        <button 
          onClick={() => setIsDarkMode(!isDarkMode)}
          className={`flex items-center justify-center md:justify-between w-full p-3 rounded-lg transition-all ${neumorphicOut} active:scale-95 mt-2`}
        >
          <span className="hidden md:block text-[10px] font-bold uppercase">{isDarkMode ? 'نهار' : 'ليل'}</span>
          {isDarkMode ? <Sun size={14} className="text-[#00d2ff]" /> : <Moon size={14} className="text-[#9d50bb]" />}
        </button>
      </aside>

      {/* Main Content */}
      <main className="flex-1 flex flex-col relative p-2 md:p-3">
        <header className={`h-11 flex items-center justify-between px-6 rounded-xl mb-2 transition-all ${neumorphicOut} border-r-2 border-r-[#00d2ff]`}>
          <div className="flex items-center gap-2">
            <div className="w-2 h-2 rounded-full bg-[#00d2ff] animate-pulse" />
            <span className="text-[9px] font-bold tracking-[0.3em] opacity-60 uppercase">elkopa core</span>
          </div>
          <button onClick={() => setShowSettings(!showSettings)} className={`p-2 rounded-lg transition-all ${neumorphicOut} hover:text-[#9d50bb]`}>
            <Settings size={14} />
          </button>
        </header>

        {/* Settings Modal - Smaller */}
        {showSettings && (
          <div className="absolute inset-0 z-50 flex items-center justify-center p-4 bg-black/10 backdrop-blur-[2px]">
            <div className={`w-full max-w-xs p-6 rounded-3xl ${neumorphicOut} ${isDarkMode ? 'bg-slate-900' : 'bg-white'} border border-[#00d2ff]/20`}>
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-sm font-black italic text-transparent bg-clip-text bg-gradient-to-r from-[#00d2ff] to-[#9d50bb]">الإعدادات</h3>
                <button onClick={() => setShowSettings(false)} className={`p-1.5 rounded-full ${neumorphicOut}`}>
                  <X size={12} />
                </button>
              </div>
              
              <div className="space-y-4">
                <div className={`p-3 rounded-xl ${neumorphicIn} flex justify-between items-center`}>
                    <span className="text-[11px] font-bold">المظهر</span>
                    <button onClick={() => setIsDarkMode(!isDarkMode)} className={`p-1.5 rounded-md ${neumorphicOut}`}>
                      {isDarkMode ? <Sun size={12} /> : <Moon size={12} />}
                    </button>
                </div>
                <div className={`p-3 rounded-xl ${neumorphicIn} flex justify-between items-center`}>
                    <span className="text-[11px] font-bold text-red-500">مسح الذاكرة</span>
                    <button onClick={clearChat} className={`p-1.5 rounded-md ${neumorphicOut}`}>
                      <RotateCcw size={12} />
                    </button>
                </div>
              </div>
              
              <button 
                onClick={() => setShowSettings(false)}
                className="w-full mt-6 py-3 rounded-xl bg-gradient-to-r from-[#00d2ff] to-[#9d50bb] text-white text-[11px] font-black shadow-md active:scale-95 transition-all"
              >
                حفظ
              </button>
            </div>
          </div>
        )}

        <div className="flex-1 overflow-y-auto px-2 md:px-16 py-4 space-y-6 scrollbar-hide">
          {messages.length === 0 ? (
            <div className="h-full flex flex-col items-center justify-center space-y-4">
              <div className={`p-8 rounded-full ${neumorphicOut} border border-[#00d2ff]/10`}>
                <Cpu size={40} className="text-[#00d2ff]" />
              </div>
              <div className="text-center">
                <h2 className={`text-2xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-[#00d2ff] to-[#9d50bb]`}>elkopa 3D</h2>
                <p className="text-slate-400 text-[10px] mt-1 tracking-widest font-bold uppercase underline decoration-[#9d50bb]">Hamza Elkopa</p>
              </div>
            </div>
          ) : (
            messages.map((msg, idx) => (
              <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                <div className={`flex gap-3 max-w-[85%] ${msg.role === 'user' ? 'flex-row-reverse' : 'flex-row'}`}>
                  <div className={`w-8 h-8 rounded-lg flex-shrink-0 flex items-center justify-center transition-all ${neumorphicOut}`}>
                    {msg.role === 'user' ? <User size={14} className="text-[#9d50bb]" /> : <Cpu size={14} className="text-[#00d2ff]" />}
                  </div>
                  <div className={`p-4 rounded-2xl ${
                    msg.role === 'user' 
                    ? `bg-slate-900 text-white shadow-md` 
                    : `${neumorphicOut} bg-white/40 backdrop-blur-sm`
                  }`}>
                    {msg.image && <img src={msg.image} className={`rounded-xl mb-2 max-w-[200px] border border-[#00d2ff]/20`} alt="Upload" />}
                    <div className={`whitespace-pre-wrap text-[13px] leading-snug font-semibold ${msg.role === 'user' ? 'text-white' : (isDarkMode ? 'text-slate-100' : 'text-black')}`}>
                      {msg.content}
                    </div>
                    {msg.sources && (
                      <div className="mt-3 pt-2 border-t border-slate-400/10 flex flex-wrap gap-2">
                        {msg.sources.map((s, i) => (
                          <a key={i} href={s.uri} target="_blank" rel="noreferrer" className={`text-[8px] px-2 py-1 rounded-md ${neumorphicOut} border border-[#00d2ff]/10`}>{s.title?.substring(0, 15)}</a>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            ))
          )}
          {isLoading && (
            <div className="flex items-center gap-2 px-6">
              <div className="w-1 h-1 bg-[#00d2ff] rounded-full animate-ping" />
              <span className="text-[9px] font-bold opacity-40 uppercase tracking-widest">Processing...</span>
            </div>
          )}
          <div ref={messagesEndRef} />
        </div>

        {/* Minimized Input */}
        <div className="p-2 md:p-4">
          <form onSubmit={handleSend} className="max-w-3xl mx-auto relative">
            <div className={`flex items-center gap-2 p-1.5 rounded-[1.5rem] transition-all ${neumorphicOut} border-b border-b-[#9d50bb]/20`}>
              <textarea
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && !e.shiftKey && handleSend(e)}
                placeholder="اسأل elkopa..."
                className={`flex-1 bg-transparent px-5 py-3 outline-none resize-none text-[14px] min-h-[40px] max-h-32 placeholder:text-slate-400 font-medium ${isDarkMode ? 'text-white' : 'text-black'}`}
                rows={1}
              />
              
              <div className="flex items-center gap-1.5 pr-2">
                <label className={`p-2.5 rounded-full cursor-pointer transition-all ${neumorphicOut} hover:text-[#00d2ff] text-slate-500`}>
                  <ImageIcon size={16} />
                  <input type="file" className="hidden" accept="image/*" onChange={(e) => {
                    const reader = new FileReader();
                    if(e.target.files[0]) {
                      reader.onload = () => setAttachedImage(reader.result);
                      reader.readAsDataURL(e.target.files[0]);
                    }
                  }} />
                </label>
                
                <button 
                  type="submit"
                  disabled={(!input.trim() && !attachedImage) || isLoading}
                  className={`p-3 rounded-full transition-all ${
                    (!input.trim() && !attachedImage) || isLoading 
                    ? 'opacity-20' 
                    : `bg-gradient-to-r from-[#00d2ff] to-[#9d50bb] text-white shadow-md active:scale-90`
                  }`}
                >
                  <Send size={16} />
                </button>
              </div>
            </div>
            <div className="text-center mt-3">
               <span className="text-[8px] font-black uppercase tracking-[0.2em] opacity-40">ELKOPA SYSTEM • HAMZA ELKOPA</span>
            </div>
          </form>
        </div>
      </main>
    </div>
  );
};

export default App;
