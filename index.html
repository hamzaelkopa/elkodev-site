<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineMate AI Pro - Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø³ÙŠÙ†Ù…Ø§Ø¦ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #080808;
            color: #d1d1d1;
        }

        .glass-header {
            background: rgba(180, 0, 0, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        #chat-box::-webkit-scrollbar {
            width: 4px;
        }
        #chat-box::-webkit-scrollbar-thumb {
            background: #b91c1c;
            border-radius: 10px;
        }

        .message-anim {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .poster-img {
            max-width: 200px;
            border-radius: 8px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.6);
            margin: 8px 0;
            border: 1px solid #b91c1c;
        }

        .glow-button {
            transition: all 0.2s ease;
        }
        .glow-button:hover {
            filter: brightness(1.2);
            transform: translateY(-1px);
        }

        .ai-bubble {
            background: #1a1a1a;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .user-bubble {
            background: #b91c1c;
        }

        .suggestion-chip {
            transition: all 0.2s;
            cursor: pointer;
            white-space: nowrap;
        }
        .suggestion-chip:hover {
            background: #b91c1c;
            color: white;
            border-color: #b91c1c;
        }
    </style>
</head>
<body class="h-screen flex items-center justify-center p-0 sm:p-6">

    <div class="app-container w-full max-w-3xl h-full sm:h-[85vh] bg-[#0f0f0f] rounded-none sm:rounded-2xl flex flex-col overflow-hidden shadow-2xl border border-white/5">
        
        <!-- Header -->
        <header class="glass-header px-5 py-3 flex justify-between items-center z-10">
            <div class="flex items-center gap-3">
                <div class="bg-white p-1.5 rounded-md text-red-700 shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z" />
                    </svg>
                </div>
                <div>
                    <h1 class="font-bold text-lg text-white leading-tight">CineMate <span class="text-[10px] tracking-widest bg-black/20 px-1.5 py-0.5 rounded border border-white/10 ml-1">PRO</span></h1>
                    <p class="text-[10px] text-white/70 uppercase tracking-tighter">AI Film Critic Platform</p>
                </div>
            </div>
            <button onclick="clearChat()" class="text-white/50 hover:text-white text-[11px] font-medium transition-colors">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø¬Ù„Ø³Ø©</button>
        </header>

        <!-- Suggestions Bar -->
        <div class="bg-black/40 border-b border-white/5 p-2 overflow-x-auto flex gap-2 no-scrollbar">
            <div onclick="quickAsk('Ø§Ù‚ØªØ±Ø­ Ù„ÙŠ Ø£ÙØ¶Ù„ 5 Ø£ÙÙ„Ø§Ù… Ø¯Ø±Ø§Ù…Ø§ ÙÙŠ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø£Ø®ÙŠØ±')" class="suggestion-chip px-3 py-1 rounded-full border border-white/10 text-[10px] text-gray-400">ğŸ­ Ø¯Ø±Ø§Ù…Ø§</div>
            <div onclick="quickAsk('Ø£ÙÙ„Ø§Ù… Ø®ÙŠØ§Ù„ Ø¹Ù„Ù…ÙŠ Ø¨Ù†Ù‡Ø§ÙŠØ§Øª ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø©')" class="suggestion-chip px-3 py-1 rounded-full border border-white/10 text-[10px] text-gray-400">ğŸš€ Ø®ÙŠØ§Ù„ Ø¹Ù„Ù…ÙŠ</div>
            <div onclick="quickAsk('Ø£ÙÙ„Ø§Ù… ØºÙ…ÙˆØ¶ ÙˆØ¬Ø±ÙŠÙ…Ø© Ø³ØªØ¬Ø¹Ù„Ù†ÙŠ Ø£ÙÙƒØ± Ø·ÙˆÙŠÙ„Ø§Ù‹')" class="suggestion-chip px-3 py-1 rounded-full border border-white/10 text-[10px] text-gray-400">ğŸ” ØºÙ…ÙˆØ¶</div>
            <div onclick="quickAsk('Ø±ÙˆØ§Ø¦Ø¹ Ø§Ù„Ø³ÙŠÙ†Ù…Ø§ Ø§Ù„ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠØ© Ø§Ù„ØªÙŠ ÙŠØ¬Ø¨ Ù…Ø´Ø§Ù‡Ø¯ØªÙ‡Ø§')" class="suggestion-chip px-3 py-1 rounded-full border border-white/10 text-[10px] text-gray-400">ğŸï¸ ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠØ§Øª</div>
            <div onclick="quickAsk('Ø§Ù‚ØªØ±Ø­ Ù„ÙŠ ÙÙŠÙ„Ù…Ø§Ù‹ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹ Ù…Ù…ØªØ¹Ø§Ù‹ Ù„Ø³Ù‡Ø±Ø© Ø§Ù„Ù„ÙŠÙ„Ø©')" class="suggestion-chip px-3 py-1 rounded-full border border-white/10 text-[10px] text-gray-400">ğŸ² Ø¹Ø´ÙˆØ§Ø¦ÙŠ</div>
        </div>

        <!-- Chat Area -->
        <main id="chat-box" class="flex-1 overflow-y-auto p-5 space-y-5 bg-[radial-gradient(circle_at_center,_#121212_0%,_#080808_100%)]">
            <!-- AI Welcome Message -->
            <div class="message-anim flex flex-col items-start max-w-[85%]">
                <div class="ai-bubble text-white/90 px-4 py-3 rounded-xl rounded-tr-none shadow-sm text-sm border-l-2 border-red-600">
                    Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ. Ø£Ù†Ø§ CineMate AI. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ø¥Ø«Ø±Ø§Ø¡ ØªØ¬Ø±Ø¨ØªÙƒ Ø§Ù„Ø³ÙŠÙ†Ù…Ø§Ø¦ÙŠØ© Ø§Ù„ÙŠÙˆÙ…ØŸ ğŸï¸
                    <div class="mt-3 grid grid-cols-2 gap-2">
                        <div class="text-[10px] bg-white/5 p-2 rounded border border-white/5">â— ØªÙˆØµÙŠØ§Øª Ù…Ø®ØµØµØ©</div>
                        <div class="text-[10px] bg-white/5 p-2 rounded border border-white/5">â— ØªØ­Ù„ÙŠÙ„ ØªÙ‚Ù†ÙŠ ÙˆÙ…Ø¹Ù…Ù‘Ù‚</div>
                    </div>
                </div>
                <span class="text-[9px] text-gray-600 mt-1 mr-1 uppercase tracking-widest">System Engine â€¢ Active</span>
            </div>
        </main>

        <!-- Input Area -->
        <footer class="px-5 py-4 bg-[#0a0a0a] border-t border-white/5">
            <div class="flex items-center gap-3 bg-[#161616] p-1.5 pl-2 rounded-xl border border-white/5 focus-within:border-red-800/50 transition-all duration-300">
                <button onclick="generatePosterPrompt()" title="ØªÙˆÙ„ÙŠØ¯ Ø¨ÙˆØ³ØªØ±" class="p-2 text-gray-500 hover:text-red-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2-2v12a2 2 0 002 2z" />
                    </svg>
                </button>
                <input type="text" id="user-input" 
                       class="flex-1 bg-transparent border-none outline-none text-white text-xs px-1" 
                       placeholder="Ø§Ø·Ù„Ø¨ ØªÙˆØµÙŠØ© Ù„ÙÙŠÙ„Ù… Ø£Ùˆ Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¹Ù„ÙˆÙ…Ø©..."
                       onkeypress="if(event.key === 'Enter') sendMessage()">
                <button onclick="sendMessage()" class="glow-button bg-red-700 text-white p-2 rounded-lg shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
            </div>
            <p class="text-[9px] text-center text-gray-600 mt-2 italic">ÙŠØ¹Ù…Ù„ Ø¨ÙˆØ§Ø³Ø·Ø© Gemini 2.5 Flash & Imagen AI</p>
        </footer>
    </div>

    <script>
        const apiKey = ""; 
        let chatHistory = [];

        async function fetchWithRetry(url, options, retries = 5, backoff = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (err) {
                    if (i === retries - 1) throw err;
                    await new Promise(r => setTimeout(r, backoff * Math.pow(2, i)));
                }
            }
        }

        function appendMessage(role, text, isImage = false) {
            const chatBox = document.getElementById('chat-box');
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `message-anim flex flex-col ${role === 'user' ? 'items-end' : 'items-start'} max-w-[85%] ${role === 'user' ? 'self-end' : 'self-start'}`;
            
            const time = new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
            
            let content = '';
            if (isImage) {
                content = `<img src="${text}" class="poster-img" alt="Movie Poster">`;
            } else {
                content = `<div class="${role === 'user' ? 'user-bubble text-white' : 'ai-bubble text-white/90'} px-4 py-2.5 rounded-xl ${role === 'user' ? 'rounded-tl-none' : 'rounded-tr-none'} shadow-sm text-sm whitespace-pre-wrap leading-relaxed">${text}</div>`;
            }

            messageWrapper.innerHTML = `
                ${content}
                <div class="flex items-center gap-2 mt-1 px-1">
                    <span class="text-[9px] text-gray-600 uppercase tracking-tighter">${role === 'user' ? 'User' : 'CineMate AI'} â€¢ ${time}</span>
                    ${role !== 'user' && !isImage ? `<button onclick="speakText(this)" class="text-[9px] text-red-500/80 hover:text-red-400 font-bold transition-colors uppercase tracking-widest">Listen ğŸ”Š</button>` : ''}
                </div>
            `;

            chatBox.appendChild(messageWrapper);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function quickAsk(text) {
            document.getElementById('user-input').value = text;
            sendMessage();
        }

        async function sendMessage() {
            const inputField = document.getElementById('user-input');
            const query = inputField.value.trim();
            if (!query) return;

            inputField.value = '';
            appendMessage('user', query);

            const loadingId = 'loading-' + Date.now();
            const chatBox = document.getElementById('chat-box');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = 'message-anim flex items-start';
            loadingDiv.innerHTML = `<div class="ai-bubble px-3 py-2 rounded-lg text-gray-400 text-[10px] animate-pulse italic">Processing Cinematic Data...</div>`;
            chatBox.appendChild(loadingDiv);
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                if (query.includes("Ø¨ÙˆØ³ØªØ±") || query.includes("ØµÙˆØ±Ø©") || query.includes("ØµÙ…Ù…")) {
                    await generateImage(query, loadingId);
                } else {
                    await generateText(query, loadingId);
                }
            } catch (error) {
                document.getElementById(loadingId).innerHTML = `<div class="bg-red-900/20 text-red-400 px-3 py-2 rounded-lg text-[10px]">Technical fault detected. Check connectivity.</div>`;
            }
        }

        async function generateText(query, loadingId) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [...chatHistory, { parts: [{ text: query }] }],
                systemInstruction: {
                    parts: [{ text: "You are CineMate AI Pro, a high-end cinematic intellectual. Respond in professional Arabic. Be concise, analytical, and sophisticated. When suggesting movies, give a brief reason for each recommendation. Focus on technical aspects like cinematography, direction, and script quality." }]
                },
                tools: [{ "google_search": {} }]
            };

            const data = await fetchWithRetry(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "No data returned.";
            
            chatHistory.push({ role: "user", parts: [{ text: query }] });
            chatHistory.push({ role: "model", parts: [{ text: aiText }] });
            if (chatHistory.length > 8) chatHistory.shift();

            document.getElementById(loadingId).remove();
            appendMessage('ai', aiText);
        }

        async function generateImage(query, loadingId) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;
            
            const promptGenUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const promptData = await fetch(promptGenUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `High-end professional movie poster prompt for: ${query}. Focus on 8k resolution, cinematic lighting, dramatic composition, award-winning style.` }] }]
                })
            }).then(r => r.json());

            const englishPrompt = promptData.candidates?.[0]?.content?.parts?.[0]?.text || query;

            const response = await fetchWithRetry(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    instances: { prompt: englishPrompt },
                    parameters: { sampleCount: 1 }
                })
            });

            const imageUrl = `data:image/png;base64,${response.predictions[0].bytesBase64Encoded}`;
            
            document.getElementById(loadingId).remove();
            appendMessage('ai', "ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø§Ù„Ø¨ØµØ±ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©:");
            appendMessage('ai', imageUrl, true);
        }

        async function speakText(btn) {
            const text = btn.parentElement.previousElementSibling.textContent;
            const originalText = btn.textContent;
            btn.textContent = "SYNTHESIZING...";
            
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: "Ø¨ØµÙˆØª Ù‡Ø§Ø¯Ø¦ ÙˆÙ†Ù‚Ø¯ÙŠ: " + text }] }],
                        generationConfig: { 
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } } 
                        },
                        model: "gemini-2.5-flash-preview-tts"
                    })
                });

                const data = await response.json();
                const pcmData = data.candidates[0].content.parts[0].inlineData.data;
                const wavUrl = pcmToWavUrl(pcmData, 24000);
                const audio = new Audio(wavUrl);
                audio.play();
                btn.textContent = "STOP â¹";
                audio.onended = () => btn.textContent = originalText;
            } catch (e) {
                btn.textContent = "ERROR";
            }
        }

        function pcmToWavUrl(base64Pcm, sampleRate) {
            const pcmBuffer = Uint8Array.from(atob(base64Pcm), c => c.charCodeAt(0)).buffer;
            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);
            const writeString = (o, s) => { for (let i = 0; i < s.length; i++) view.setUint8(o + i, s.charCodeAt(i)); };
            writeString(0, 'RIFF');
            view.setUint32(4, 32 + pcmBuffer.byteLength, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, pcmBuffer.byteLength, true);
            return URL.createObjectURL(new Blob([wavHeader, pcmBuffer], { type: 'audio/wav' }));
        }

        function clearChat() {
            if(confirm("Clear current sequence?")) {
                document.getElementById('chat-box').innerHTML = `
                    <div class="message-anim flex flex-col items-start max-w-[85%]">
                        <div class="ai-bubble text-white/90 px-4 py-3 rounded-xl shadow-sm text-sm">Sequence Reset. Awaiting Input.</div>
                    </div>
                `;
                chatHistory = [];
            }
        }

        function generatePosterPrompt() {
            document.getElementById('user-input').value = "ØµÙ…Ù… Ø¨ÙˆØ³ØªØ± Ù„ÙÙŠÙ„Ù… Neo-Noir ÙÙŠ Ù…Ø¯ÙŠÙ†Ø© Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©";
            sendMessage();
        }
    </script>
</body>
</html>
