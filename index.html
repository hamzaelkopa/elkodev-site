<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DONCOD LIFE</title>

<script src="https://cdn.tailwindcss.com"></script>

<style>
body{font-family:sans-serif;background:#0b0f19;color:#e5e7eb}
.card{background:#111827;border:1px solid #1f2937;border-radius:14px;padding:16px}
.btn{background:#4f46e5;padding:10px 14px;border-radius:10px}
.btn:disabled{opacity:.5}
input{background:#0f172a;border:1px solid #1f2937;padding:10px;border-radius:10px;width:100%}
</style>
</head>

<body class="p-4">

<h1 class="text-xl font-bold mb-4">DONCOD LIFE â€” Ù…Ù†Ø¸Ù… Ø§Ù„Ø­ÙŠØ§Ø©</h1>

<div class="card mb-4">
<form id="taskForm" class="flex gap-2">
<input id="taskInput" maxlength="120" placeholder="Ø§ÙƒØªØ¨ Ù…Ù‡Ù…Ø©...">
<button class="btn" id="addBtn">Ø¥Ø¶Ø§ÙØ©</button>
</form>
</div>

<div class="card mb-4">
<h2 class="font-bold mb-2">Ø§Ù„Ù…Ù‡Ø§Ù…</h2>
<div id="taskList"></div>
</div>

<div class="card mb-4">
<h2 class="font-bold mb-2">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
<div>Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="xp">0</span></div>
<div>Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ø£ÙŠØ§Ù…: <span id="streak">0</span></div>
</div>

<div class="card mb-4">
<button class="btn" id="exportBtn">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
<button class="btn bg-gray-700" id="importBtn">Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
<input type="file" id="importFile" hidden>
</div>

<div class="card">
<button class="btn bg-red-700" id="resetBtn">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
</div>

<script>
/* =========================
   SAFE STORAGE HELPERS
========================= */

function safeParse(key, fallback){
  try{
    const v = JSON.parse(localStorage.getItem(key))
    return v ?? fallback
  }catch{
    return fallback
  }
}

function saveKey(key,val){
  localStorage.setItem(key,JSON.stringify(val))
}

/* =========================
   STATE
========================= */

const state = {
 tasks: safeParse("dl_tasks",[]),
 history: safeParse("dl_history",[]),
 xp: safeParse("dl_xp",0),
 streak: safeParse("dl_streak",0),
 busy:false
}

/* =========================
   SAVE
========================= */

function saveAll(){
 saveKey("dl_tasks",state.tasks)
 saveKey("dl_history",state.history)
 saveKey("dl_xp",state.xp)
 saveKey("dl_streak",state.streak)
}

/* =========================
   SAFE TEXT NODE (ANTI XSS)
========================= */

function textNode(t){
 return document.createTextNode(t)
}

/* =========================
   RENDER
========================= */

function renderTasks(){
 const box=document.getElementById("taskList")
 box.innerHTML=""

 if(state.tasks.length===0){
   const p=document.createElement("p")
   p.className="opacity-50"
   p.appendChild(textNode("Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ù…Ù‡Ù…Ø© ğŸš€"))
   box.appendChild(p)
   return
 }

 state.tasks.forEach(task=>{
   const row=document.createElement("div")
   row.className="flex justify-between items-center mb-2"

   const span=document.createElement("span")
   span.appendChild(textNode(task.text))
   if(task.done) span.className="line-through opacity-50"

   const btn=document.createElement("button")
   btn.className="btn text-sm"
   btn.textContent= task.done ? "âœ“" : "Ø¥Ù†Ø¬Ø§Ø²"
   btn.disabled=task.done
   btn.onclick=()=>completeTask(task.id)

   const del=document.createElement("button")
   del.className="btn bg-red-700 text-sm mr-2"
   del.textContent="Ø­Ø°Ù"
   del.onclick=()=>deleteTask(task.id)

   const right=document.createElement("div")
   right.appendChild(btn)
   right.appendChild(del)

   row.appendChild(span)
   row.appendChild(right)
   box.appendChild(row)
 })
 updateStats()
}

/* =========================
   VALIDATION
========================= */

function cleanInput(v){
 return v.replace(/[<>]/g,"").trim()
}

/* =========================
   ADD TASK
========================= */

document.getElementById("taskForm").onsubmit=e=>{
 e.preventDefault()
 if(state.busy) return
 state.busy=true

 const inp=document.getElementById("taskInput")
 let v=cleanInput(inp.value)

 if(v.length<2){ state.busy=false; return }

 state.tasks.unshift({
   id:Date.now(),
   text:v,
   done:false,
   created:Date.now()
 })

 inp.value=""
 saveAll()
 renderTasks()
 state.busy=false
}

/* =========================
   COMPLETE
========================= */

function completeTask(id){
 const t=state.tasks.find(x=>x.id===id)
 if(!t||t.done) return
 t.done=true
 t.doneAt=Date.now()

 state.history.push(t.doneAt)
 state.xp+=20
 updateStreak()

 saveAll()
 renderTasks()
}

/* =========================
   DELETE
========================= */

function deleteTask(id){
 state.tasks=state.tasks.filter(x=>x.id!==id)
 saveAll()
 renderTasks()
}

/* =========================
   STREAK
========================= */

function updateStreak(){
 if(state.history.length<2){
   state.streak=1
   return
 }
 const last=new Date(state.history.at(-1)).toDateString()
 const prev=new Date(state.history.at(-2)).toDateString()

 if(last!==prev) state.streak++
}

/* =========================
   STATS
========================= */

function updateStats(){
 document.getElementById("xp").textContent=state.xp
 document.getElementById("streak").textContent=state.streak
}

/* =========================
   EXPORT
========================= */

document.getElementById("exportBtn").onclick=()=>{
 const data=JSON.stringify(state)
 const blob=new Blob([data],{type:"application/json"})
 const a=document.createElement("a")
 a.href=URL.createObjectURL(blob)
 a.download="doncod-backup.json"
 a.click()
}

/* =========================
   IMPORT
========================= */

document.getElementById("importBtn").onclick=()=>{
 document.getElementById("importFile").click()
}

document.getElementById("importFile").onchange=e=>{
 const file=e.target.files[0]
 if(!file) return
 const r=new FileReader()
 r.onload=()=>{
   try{
     const d=JSON.parse(r.result)
     state.tasks=d.tasks||[]
     state.history=d.history||[]
     state.xp=d.xp||0
     state.streak=d.streak||0
     saveAll()
     renderTasks()
   }catch{
     alert("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­")
   }
 }
 r.readAsText(file)
}

/* =========================
   RESET SAFE
========================= */

document.getElementById("resetBtn").onclick=()=>{
 if(!confirm("Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ© ÙÙ‚Ø·ØŸ")) return
 localStorage.removeItem("dl_tasks")
 localStorage.removeItem("dl_history")
 localStorage.removeItem("dl_xp")
 localStorage.removeItem("dl_streak")
 location.reload()
}

/* =========================
   INIT
========================= */

renderTasks()
</script>

</body>
</html>
